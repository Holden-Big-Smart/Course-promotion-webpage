<!DOCTYPE html>
<html>

<head>
    <title>åå°ç®¡ç†é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .multi-select-wrapper {
            position: relative;
        }

        .multi-display-box {
            min-height: 42px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: white;
        }

        .tag-chip {
            background-color: #e0e7ff;
            /* blue-100 */
            color: #3730a3;
            /* indigo-800 */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag-remove {
            cursor: pointer;
            hover: text-red-500;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            z-index: 50;
            width: 100%;
            max-height: 240px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
        }

        .dropdown-item.selected {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .dropdown-item.selected::after {
            content: 'âœ”';
            font-size: 12px;
        }

        .add-btn-area {
            border-top: 1px solid #e5e7eb;
            padding: 8px 12px;
            color: #6b7280;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .add-btn-area:hover {
            background-color: #f9fafb;
            color: #2563eb;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <nav class="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <span class="font-bold text-xl">è¯¾ç¨‹ç®¡ç†åå°</span>
        <div>
            <span class="mr-4">æ¬¢è¿, <%= user %></span>
            <a href="/" target="_blank" class="mr-4 hover:text-gray-300">æŸ¥çœ‹å‰å°</a>
            <a href="/admin/logout" class="bg-red-500 px-3 py-1 rounded text-sm hover:bg-red-600">é€€å‡º</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="bg-white p-6 rounded shadow h-fit lg:col-span-1">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-green-700">å‘å¸ƒæ–°è¯¾ç¨‹</h3>

            <form action="/admin/course/add" method="POST" enctype="multipart/form-data" class="space-y-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹åç§°</label>
                    <input type="text" name="title"
                        class="w-full border rounded p-2 focus:ring-2 focus:ring-green-200 outline-none" required>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ä»·æ ¼ (HK$)</label>
                        <input type="number" name="price"
                            class="w-full border rounded p-2 focus:ring-2 focus:ring-green-200 outline-none" required>
                    </div>

                    <div class="multi-select-wrapper" id="category-select">
                        <label class="block text-sm font-medium text-gray-700">åˆ†ç±»æ ‡ç­¾ (å¯å¤šé€‰)</label>
                        <input type="hidden" name="category" id="category-input">
                        <div class="multi-display-box border rounded p-2" onclick="toggleDropdown('category-select')">
                            <span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>
                        </div>

                        <div class="dropdown-menu" id="category-list">
                            <div id="category-options-container"></div>

                            <div class="add-btn-area flex items-center gap-2" onclick="addNewCategory(event)">
                                <i class="fas fa-plus"></i>
                                <span>æ–°å»ºåˆ†ç±»æ ‡ç­¾</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¼€è¯¾æ—¶é—´</label>
                        <input type="date" name="startTime" class="w-full border rounded p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ç»“è¯¾æ—¶é—´</label>
                        <input type="date" name="endTime" class="w-full border rounded p-2" required>
                    </div>
                </div>

                <div class="multi-select-wrapper" id="weekday-select">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šè¯¾æ—¶é—´ (å¯å¤šé€‰)</label>
                    <input type="hidden" name="weekDay" id="weekday-input">

                    <div class="multi-display-box border rounded p-2" onclick="toggleDropdown('weekday-select')">
                        <span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>
                    </div>

                    <div class="dropdown-menu">
                        <div id="weekday-options-container">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹ç®€ä»‹</label>
                    <textarea name="description" rows="2" class="w-full border rounded p-2"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹å°é¢å›¾</label>
                    <input type="file" name="image" accept="image/*" class="w-full border rounded p-2 bg-gray-50"
                        required>
                </div>

                <button type="submit"
                    class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold shadow-md transition">å‘å¸ƒè¯¾ç¨‹</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded shadow lg:col-span-2">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-gray-700">å·²å‘å¸ƒè¯¾ç¨‹ (<%= courses.length %>)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-3 py-3">å›¾ç‰‡</th>
                            <th class="px-3 py-3">è¯¦æƒ…</th>
                            <th class="px-3 py-3 w-20">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% courses.forEach(course=> { %>
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-3 py-2 w-20">
                                    <img src="<%= course.image %>" class="w-16 h-12 object-cover rounded border">
                                </td>
                                <td class="px-3 py-2">
                                    <div class="font-bold text-gray-900 text-base">
                                        <%= course.title %>
                                    </div>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        <% course.category.forEach(cat=> { %>
                                            <span
                                                class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">
                                                <%= cat %>
                                            </span>
                                            <% }) %>
                                                <span class="text-red-600 font-bold ml-2">HK$<%= course.price %></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ğŸ“… <%= course.startTime %> ~ <%= course.endTime %>
                                    </div>
                                    <div class="flex flex-wrap gap-1 mt-1 text-xs text-purple-600 font-medium">
                                        <% course.weekDay.forEach(day=> { %>
                                            <span>
                                                <%= day %>
                                            </span>
                                            <% }) %>
                                    </div>
                                </td>
                                <td class="px-3 py-2">
                                    <div class="flex flex-col gap-2">
                                        <a href="/admin/course/edit/<%= course._id %>"
                                            class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs text-center">
                                            ä¿®æ”¹
                                        </a>

                                        <a href="/admin/course/delete/<%= course._id %>"
                                            onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')"
                                            class="text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs text-center">
                                            åˆ é™¤
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. æ•°æ®åˆå§‹åŒ– (å®‰å…¨æ¨¡å¼)
        // ==========================================

        // âš ï¸ ä¿®å¤æ ¸å¿ƒï¼šå¦‚æœ categories ä¸ºç©º/æœªå®šä¹‰ï¼Œå¼ºåˆ¶èµ‹å€¼ä¸º "[]" (ç©ºæ•°ç»„å­—ç¬¦ä¸²)
        // è¿™æ ·ç”Ÿæˆçš„ä»£ç å°±æ˜¯ var serverCategories = []; ä¸ä¼šæŠ¥é”™
        var serverCategories = <%- (typeof categories !== 'undefined' && categories) ? JSON.stringify(categories) : "[]" %>;

        var weekDaysData = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];

        // å®šä¹‰å…¨å±€çŠ¶æ€
        var state = {
            'category-select': { selected: [], options: serverCategories, type: 'category' },
            'weekday-select': { selected: [], options: weekDaysData.map(function (d) { return { name: d }; }), type: 'weekday' }
        };

        // ==========================================
        // 2. å…¨å±€å‡½æ•°å®šä¹‰ (ä¿®å¤ ReferenceError)
        // ==========================================

        // æ¸²æŸ“ä¸‹æ‹‰é€‰é¡¹
        function renderOptions(wrapperId) {
            var wrapper = document.getElementById(wrapperId);
            if (!wrapper) return;

            // åŠ¨æ€æŸ¥æ‰¾å®¹å™¨ ID
            var containerId = state[wrapperId].type === 'category' ? 'category-options-container' : 'weekday-options-container';
            var container = document.getElementById(containerId);

            if (!container) return;

            container.innerHTML = '';
            var currentData = state[wrapperId];

            // æ¸²æŸ“åˆ—è¡¨é¡¹
            currentData.options.forEach(function (opt) {
                var isSelected = currentData.selected.includes(opt.name);
                var div = document.createElement('div');
                div.className = 'dropdown-item ' + (isSelected ? 'selected' : '');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶ (é€‰æ‹©/å–æ¶ˆ)
                div.onclick = function (e) { toggleSelection(e, wrapperId, opt.name); };

                var content = '<span>' + opt.name + '</span>';

                // å¦‚æœæ˜¯åˆ†ç±»ï¼Œæ·»åŠ åˆ é™¤å°å›¾æ ‡
                if (currentData.type === 'category') {
                    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†è½¬ä¹‰å­—ç¬¦ \ æ¥å¤„ç†å¼•å·
                    content += '<i onclick="deleteCategory(event, \'' + opt._id + '\', \'' + opt.name + '\')" class="fas fa-trash-alt text-gray-300 hover:text-red-500 transition px-2"></i>';
                }
                div.innerHTML = content;
                container.appendChild(div);
            });

            updateDisplay(wrapperId);
        }

        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€é€»è¾‘
        function toggleSelection(e, wrapperId, value) {
            if (e) e.stopPropagation();
            var current = state[wrapperId].selected;
            var index = current.indexOf(value);

            if (index > -1) current.splice(index, 1); // å·²å­˜åœ¨åˆ™ç§»é™¤
            else current.push(value); // ä¸å­˜åœ¨åˆ™æ·»åŠ 

            renderOptions(wrapperId);
        }

        // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º (è“è‰²èƒ¶å›Šæ ‡ç­¾)
        function updateDisplay(wrapperId) {
            var wrapper = document.getElementById(wrapperId);
            var displayBox = wrapper.querySelector('.multi-display-box');
            var input = wrapper.querySelector('input[type="hidden"]');

            // æ›´æ–°éšè— input çš„å€¼ (é€—å·åˆ†éš”)ï¼Œç”¨äºè¡¨å•æäº¤
            input.value = state[wrapperId].selected.join(',');

            displayBox.innerHTML = '';
            if (state[wrapperId].selected.length === 0) {
                displayBox.innerHTML = '<span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>';
            } else {
                state[wrapperId].selected.forEach(function (val) {
                    var tag = document.createElement('span');
                    tag.className = 'tag-chip';
                    // æ ‡ç­¾ä¸Šçš„ X æŒ‰é’®
                    tag.innerHTML = val + ' <span class="tag-remove" onclick="removeTag(event, \'' + wrapperId + '\', \'' + val + '\')">&times;</span>';
                    displayBox.appendChild(tag);
                });
            }
        }

        // ç§»é™¤å•ä¸ªæ ‡ç­¾
        function removeTag(e, wrapperId, value) {
            e.stopPropagation();
            toggleSelection(null, wrapperId, value);
        }

        // æ‰“å¼€/å…³é—­ä¸‹æ‹‰èœå• (HTML onclick å…¥å£)
        function toggleDropdown(wrapperId) {
            var wrapper = document.getElementById(wrapperId);
            var menu = wrapper.querySelector('.dropdown-menu');

            // å…ˆå…³é—­å…¶ä»–æ‰€æœ‰å·²æ‰“å¼€çš„èœå•
            document.querySelectorAll('.dropdown-menu').forEach(function (m) {
                if (m !== menu) m.classList.remove('show');
            });

            // åˆ‡æ¢å½“å‰èœå•
            menu.classList.toggle('show');
        }

        // æ·»åŠ æ–°åˆ†ç±» (AJAX)
        async function addNewCategory(e) {
            e.stopPropagation();
            var name = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»æ ‡ç­¾åç§°:");
            if (!name) return;

            try {
                var res = await fetch('/admin/category/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                var json = await res.json();

                if (json.status === 'ok') {
                    state['category-select'].options.push(json.data);
                    state['category-select'].selected.push(json.data.name);
                    renderOptions('category-select');
                } else {
                    alert(json.msg || 'æ·»åŠ å¤±è´¥');
                }
            } catch (err) {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆ é™¤åˆ†ç±» (AJAX)
        async function deleteCategory(e, id, name) {
            e.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ ‡ç­¾ã€' + name + 'ã€‘å—ï¼Ÿ')) return;
            try {
                var res = await fetch('/admin/category/delete/' + id, { method: 'DELETE' });
                var json = await res.json();
                if (json.status === 'ok') {
                    // ä»é€‰é¡¹ä¸­ç§»é™¤
                    state['category-select'].options = state['category-select'].options.filter(function (c) { return c._id !== id; });
                    // å¦‚æœå·²é€‰ä¸­ï¼Œä¹Ÿç§»é™¤
                    state['category-select'].selected = state['category-select'].selected.filter(function (s) { return s !== name; });
                    renderOptions('category-select');
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (err) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ==========================================
        // 3. åˆå§‹åŒ–æ‰§è¡Œ
        // ==========================================
        document.addEventListener('DOMContentLoaded', function () {
            console.log("åˆå§‹åŒ–ç»„ä»¶...");

            // æ¸²æŸ“åˆå§‹çŠ¶æ€
            renderOptions('category-select');
            renderOptions('weekday-select');

            // ç‚¹å‡»é¡µé¢ç©ºç™½å¤„å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function (e) {
                var wrappers = document.querySelectorAll('.multi-select-wrapper');
                wrappers.forEach(function (wrapper) {
                    if (!wrapper.contains(e.target)) {
                        var menu = wrapper.querySelector('.dropdown-menu');
                        if (menu) menu.classList.remove('show');
                    }
                });
            });
        });
    </script>
</body>

</html>