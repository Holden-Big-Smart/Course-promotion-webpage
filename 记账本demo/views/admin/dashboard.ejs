<!DOCTYPE html>
<html>
<head>
    <title>åå°ç®¡ç†é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .multi-select-wrapper { position: relative; }
        .multi-display-box {
            min-height: 42px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: white;
        }
        .tag-chip {
            background-color: #e0e7ff; /* blue-100 */
            color: #3730a3; /* indigo-800 */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .tag-remove { cursor: pointer; hover: text-red-500; }
        .dropdown-menu {
            display: none;
            position: absolute;
            z-index: 50;
            width: 100%;
            max-height: 240px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-item:hover { background-color: #f3f4f6; }
        .dropdown-item.selected { background-color: #eff6ff; color: #2563eb; }
        .dropdown-item.selected::after { content: 'âœ”'; font-size: 12px; }
        
        .add-btn-area {
            border-top: 1px solid #e5e7eb;
            padding: 8px 12px;
            color: #6b7280;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .add-btn-area:hover { background-color: #f9fafb; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <span class="font-bold text-xl">è¯¾ç¨‹ç®¡ç†åå°</span>
        <div>
            <span class="mr-4">æ¬¢è¿, <%= user %></span>
            <a href="/" target="_blank" class="mr-4 hover:text-gray-300">æŸ¥çœ‹å‰å°</a>
            <a href="/admin/logout" class="bg-red-500 px-3 py-1 rounded text-sm hover:bg-red-600">é€€å‡º</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="bg-white p-6 rounded shadow h-fit lg:col-span-1">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-green-700">å‘å¸ƒæ–°è¯¾ç¨‹</h3>
            
            <form action="/admin/course/add" method="POST" enctype="multipart/form-data" class="space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹åç§°</label>
                    <input type="text" name="title" class="w-full border rounded p-2 focus:ring-2 focus:ring-green-200 outline-none" required>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ä»·æ ¼ (HK$)</label>
                        <input type="number" name="price" class="w-full border rounded p-2 focus:ring-2 focus:ring-green-200 outline-none" required>
                    </div>
                    
                    <div class="multi-select-wrapper" id="category-select">
                        <label class="block text-sm font-medium text-gray-700">åˆ†ç±»æ ‡ç­¾ (å¯å¤šé€‰)</label>
                        <input type="hidden" name="category" id="category-input"> <div class="multi-display-box border rounded p-2" onclick="toggleDropdown('category-select')">
                            <span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>
                        </div>

                        <div class="dropdown-menu" id="category-list">
                            <div id="category-options-container"></div>
                            
                            <div class="add-btn-area flex items-center gap-2" onclick="addNewCategory(event)">
                                <i class="fas fa-plus"></i>
                                <span>æ–°å»ºåˆ†ç±»æ ‡ç­¾</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¼€è¯¾æ—¶é—´</label>
                        <input type="date" name="startTime" class="w-full border rounded p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ç»“è¯¾æ—¶é—´</label>
                        <input type="date" name="endTime" class="w-full border rounded p-2" required>
                    </div>
                </div>

                <div class="multi-select-wrapper" id="weekday-select">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šè¯¾æ—¶é—´ (å¯å¤šé€‰)</label>
                    <input type="hidden" name="weekDay" id="weekday-input">
                    
                    <div class="multi-display-box border rounded p-2" onclick="toggleDropdown('weekday-select')">
                        <span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>
                    </div>

                    <div class="dropdown-menu">
                        <div id="weekday-options-container">
                            </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹ç®€ä»‹</label>
                    <textarea name="description" rows="2" class="w-full border rounded p-2"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯¾ç¨‹å°é¢å›¾</label>
                    <input type="file" name="image" accept="image/*" class="w-full border rounded p-2 bg-gray-50" required>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold shadow-md transition">å‘å¸ƒè¯¾ç¨‹</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded shadow lg:col-span-2">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-gray-700">å·²å‘å¸ƒè¯¾ç¨‹ (<%= courses.length %>)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-3 py-3">å›¾ç‰‡</th>
                            <th class="px-3 py-3">è¯¦æƒ…</th>
                            <th class="px-3 py-3 w-20">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% courses.forEach(course => { %>
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-3 py-2 w-20">
                                <img src="<%= course.image %>" class="w-16 h-12 object-cover rounded border">
                            </td>
                            <td class="px-3 py-2">
                                <div class="font-bold text-gray-900 text-base"><%= course.title %></div>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    <% course.category.forEach(cat => { %>
                                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">
                                            <%= cat %>
                                        </span>
                                    <% }) %>
                                    <span class="text-red-600 font-bold ml-2">HK$<%= course.price %></span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ğŸ“… <%= course.startTime %> ~ <%= course.endTime %>
                                </div>
                                <div class="flex flex-wrap gap-1 mt-1 text-xs text-purple-600 font-medium">
                                    <% course.weekDay.forEach(day => { %>
                                        <span><%= day %></span>
                                    <% }) %>
                                </div>
                            </td>
                            <td class="px-3 py-2">
                                <a href="/admin/course/delete/<%= course._id %>" onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')" class="text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs">
                                    åˆ é™¤
                                </a>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let categories = <%- JSON.stringify(categories) %>;
        const weekDays = ['æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­','æ˜ŸæœŸæ—¥'];

        // çŠ¶æ€å­˜å‚¨
        const state = {
            'category-select': { selected: [], options: categories, type: 'category' },
            'weekday-select': { selected: [], options: weekDays.map(d => ({ name: d })), type: 'weekday' }
        };

        // åˆå§‹åŒ–æ¸²æŸ“
        renderOptions('category-select');
        renderOptions('weekday-select');

        // é€šç”¨æ¸²æŸ“å‡½æ•°
        function renderOptions(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const container = wrapper.querySelector(state[wrapperId].type === 'category' ? '#category-options-container' : '#weekday-options-container');
            container.innerHTML = '';

            const currentData = state[wrapperId];

            currentData.options.forEach(opt => {
                const isSelected = currentData.selected.includes(opt.name);
                const div = document.createElement('div');
                div.className = `dropdown-item ${isSelected ? 'selected' : ''}`;
                div.onclick = (e) => toggleSelection(e, wrapperId, opt.name);
                
                // å†…å®¹ç»“æ„
                let content = `<span>${opt.name}</span>`;
                
                // å¦‚æœæ˜¯åˆ†ç±»ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®
                if (currentData.type === 'category') {
                    content += `<i onclick="deleteCategory(event, '${opt._id}', '${opt.name}')" class="fas fa-trash-alt text-gray-300 hover:text-red-500 transition px-2"></i>`;
                }
                
                div.innerHTML = content;
                container.appendChild(div);
            });

            updateDisplay(wrapperId);
        }

        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        function toggleSelection(e, wrapperId, value) {
            // é˜²æ­¢è§¦å‘å¤–å±‚ç‚¹å‡»
            if(e) e.stopPropagation();

            const current = state[wrapperId].selected;
            const index = current.indexOf(value);
            
            if (index > -1) {
                current.splice(index, 1); // å–æ¶ˆé€‰ä¸­
            } else {
                current.push(value); // é€‰ä¸­
            }

            renderOptions(wrapperId); // é‡æ–°æ¸²æŸ“åˆ—è¡¨(æ›´æ–°é«˜äº®)
        }

        // æ›´æ–°æ˜¾ç¤ºæ¡†å’Œéšè— Input
        function updateDisplay(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const displayBox = wrapper.querySelector('.multi-display-box');
            const input = wrapper.querySelector('input[type="hidden"]');
            const placeholder = displayBox.querySelector('.placeholder-text');
            const selected = state[wrapperId].selected;

            // æ›´æ–° Input å€¼ (é€—å·åˆ†éš”)
            input.value = selected.join(',');

            // æ¸…ç©ºç°æœ‰æ ‡ç­¾ï¼ˆä¿ç•™ placeholder ç»“æ„ç”¨äºåˆ¤æ–­ï¼‰
            displayBox.innerHTML = '';

            if (selected.length === 0) {
                displayBox.innerHTML = '<span class="text-gray-400 text-sm ml-1 placeholder-text">è¯·é€‰æ‹©...</span>';
            } else {
                selected.forEach(val => {
                    const tag = document.createElement('span');
                    tag.className = 'tag-chip';
                    tag.innerHTML = `${val} <span class="tag-remove" onclick="removeTag(event, '${wrapperId}', '${val}')">&times;</span>`;
                    displayBox.appendChild(tag);
                });
            }
        }

        // ç‚¹å‡»æ ‡ç­¾ä¸Šçš„ X ç§»é™¤
        function removeTag(e, wrapperId, value) {
            e.stopPropagation();
            toggleSelection(null, wrapperId, value);
        }

        // åˆ‡æ¢ä¸‹æ‹‰æ¡†æ˜¾ç¤º
        function toggleDropdown(wrapperId) {
            const menu = document.querySelector(`#${wrapperId} .dropdown-menu`);
            const allMenus = document.querySelectorAll('.dropdown-menu');
            
            // å…³é—­å…¶ä»–æ‰€æœ‰æ‰“å¼€çš„èœå•
            allMenus.forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });

            menu.classList.toggle('show');
        }

        // === åˆ†ç±»ç‰¹æœ‰é€»è¾‘ ===

        // æ·»åŠ æ–°åˆ†ç±»
        async function addNewCategory(e) {
            e.stopPropagation(); // é˜²æ­¢å…³é—­ä¸‹æ‹‰æ¡†
            const name = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»æ ‡ç­¾åç§°:");
            if (!name) return;

            try {
                const res = await fetch('/admin/category/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const json = await res.json();

                if (json.status === 'ok') {
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    state['category-select'].options.push(json.data);
                    // è‡ªåŠ¨é€‰ä¸­æ–°æ·»åŠ çš„
                    state['category-select'].selected.push(json.data.name);
                    renderOptions('category-select');
                } else {
                    alert(json.msg || 'æ·»åŠ å¤±è´¥');
                }
            } catch (err) {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(e, id, name) {
            e.stopPropagation();
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾ã€${name}ã€‘å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/admin/category/delete/${id}`, { method: 'DELETE' });
                const json = await res.json();

                if (json.status === 'ok') {
                    // ä»é€‰é¡¹ä¸­ç§»é™¤
                    state['category-select'].options = state['category-select'].options.filter(c => c._id !== id);
                    // ä»å·²é€‰ä¸­ç§»é™¤
                    state['category-select'].selected = state['category-select'].selected.filter(s => s !== name);
                    renderOptions('category-select');
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (err) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            const wrappers = document.querySelectorAll('.multi-select-wrapper');
            wrappers.forEach(wrapper => {
                if (!wrapper.contains(e.target)) {
                    wrapper.querySelector('.dropdown-menu').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>